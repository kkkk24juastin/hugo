# Hugo 博客自动编译
# 编译后将静态文件保存为artifact，并推送到 gh-pages 分支供服务器拉取
name: Build Hugo Site

on:
  # 当推送到 main 分支时触发
  push:
    branches:
      - main
  # 允许手动触发工作流
  workflow_dispatch:

# 设置权限
permissions:
  contents: write

# 只允许一个并发构建
concurrency:
  group: "build"
  cancel-in-progress: false

# 默认使用 bash
defaults:
  run:
    shell: bash

jobs:
  # 构建任务
  build:
    runs-on: ubuntu-latest
    env:
      HUGO_VERSION: 0.155.2
    steps:
      - name: Install Hugo CLI
        run: |
          wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb \
          && sudo dpkg -i ${{ runner.temp }}/hugo.deb

      - name: Install Dart Sass
        run: sudo snap install dart-sass

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Node.js dependencies
        run: "[[ -f package-lock.json || -f npm-shrinkwrap.json ]] && npm ci || true"

      - name: Build with Hugo
        env:
          HUGO_CACHEDIR: ${{ runner.temp }}/hugo_cache
          HUGO_ENVIRONMENT: production
          TZ: Asia/Shanghai
        run: |
          hugo \
            --gc \
            --minify

      # 将静态文件作为 artifact 上传，可在 Actions 页面下载
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: hugo-site
          path: ./public
          retention-days: 30

      # 将静态文件推送到 gh-pages 分支，供服务器拉取
      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy: ${{ github.sha }}'

      # 清除 Cloudflare 缓存
      # 需要在 GitHub 仓库设置 Secrets：
      # - CF_ZONE_ID: Cloudflare 域名概览页右下角的 Zone ID
      # - CF_API_TOKEN: Cloudflare API Token（需要 Zone.Cache Purge 权限）
      - name: Purge Cloudflare Cache
        if: success()
        run: |
          echo "Purging Cloudflare cache..."
          response=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}')
          
          success=$(echo $response | jq -r '.success')
          if [ "$success" = "true" ]; then
            echo "✅ Cloudflare cache purged successfully!"
          else
            echo "❌ Failed to purge cache:"
            echo $response | jq .
            exit 1
          fi
        env:
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
